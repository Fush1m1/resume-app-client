name: Deploy React App to S3

on:
  push:
    branches:
      - main  # mainブランチにpushされた時にデプロイ

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
    # リポジトリをチェックアウト
    - name: Checkout code
      uses: actions/checkout@v2

    # Node.js をセットアップ
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    # 依存関係のインストール
    - name: Install dependencies
      run: npm install

    # Next.js アプリをビルド
    - name: Build the app
      run: npm run build

    # アプリのエクスポート（静的サイトに変換）
    - name: Export the app
      run: npm run export

    # AWS CLI をインストール
    - name: Install AWS CLI
      run: |
        curl "https://d1vvhvl2y92vvt.cloudfront.net/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install

    # AWS S3 にデプロイ
    - name: Deploy to S3
      run: |
        aws s3 sync ./out s3://my-resumeapp-bucket --delete --acl public-read --region ap-northeast-1

    # オプション: CloudFront の無効化 (キャッシュをクリア)
    - name: Invalidate CloudFront cache
      run: |
        aws cloudfront create-invalidation --distribution-id YOUR_DISTRIBUTION_ID --paths "/*"
